const admin = require("firebase-admin");
async function init(){ if(admin.apps && admin.apps.length) return; const b64 = process.env.FIREBASE_SERVICE_ACCOUNT_BASE64||""; if(!b64) throw new Error("Missing FIREBASE_SERVICE_ACCOUNT_BASE64"); const svc = JSON.parse(Buffer.from(b64,"base64").toString("utf8")); admin.initializeApp({ credential: admin.credential.cert(svc) }); }
exports.handler = async function(event){ try{ await init(); const body = JSON.parse(event.body||"{}"); const jobId = body.jobId; const providerId = body.providerId; if(!jobId||!providerId) return { statusCode:400, body: JSON.stringify({ error: "missing" }) }; const db = require('firebase-admin').firestore(); const jobRef = db.collection('jobs').doc(jobId); const jobSnap = await jobRef.get(); if(!jobSnap.exists) return { statusCode:404, body: JSON.stringify({ error: "not found" }) }; await jobRef.update({ status: "assigned", providerId, assignedAt: require('firebase-admin').firestore.FieldValue.serverTimestamp() }); return { statusCode:200, body: JSON.stringify({ ok:true }) }; }catch(e){ console.error(e); return { statusCode:500, body: JSON.stringify({ error: e.message||e }) }; } }